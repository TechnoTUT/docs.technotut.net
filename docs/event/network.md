---
title: Network
sidebar_label: Network
sidebar_position: 5
---
Last update: 2023/10/21 by DDlia  
--- 
## 概要
ここではイベント時のネットワークについて説明します。  
部室運用時のネットワーク構成は、`Network`カテゴリを参照してください。  
![network](https://raw.githubusercontent.com/TechnoTUT/Infrastructure/main/network_event.drawio.svg)  
ルーターとしてNEC UNIVERGE IX3110、L3スイッチとしてAllied Telesis AT-x600-48Ts、L2スイッチとしてCisco Catalyst 2960+ 24TC-LとAllied Telesis AT-x210-24GT、 Allied Telesis GS924M V2を、無線APにはCisco Aironet 2700を使用しています。  

Pro DJ Link機能により、コンピュータで楽曲情報を取得したり、スマートフォンやタブレットでDJを行ったりすることができます。さらに、NDIによって映像をネットワーク経由で送受信したり、照明用の通信を行うことができます。  

## 設営について
以下の通りに配線を行います。  
まずは、スイッチ同士の配線から行います。  
![network](https://raw.githubusercontent.com/TechnoTUT/Infrastructure/main/network_event.drawio.svg)  
なお、スイッチ内の数字はポート番号を表しています。  
Allied Telesis AT-x600-48Tsの`port1.0.42, port1.0.45, port1.0.46, port1.0.47, port1.0.48`およびAllied Telesis AT-x210-24GT、Allied Telesis GS924M V2の`port1.0.15, port1.0.16, port1.0.23, port1.0.24`、Cisco Catalyst 2960 Plus 24TC-Lの`Gi0/1`ポートは、Taggedポートに設定されており、スイッチ間やサーバとの接続に使用します。  
Cisco Catalyst 2960 Plus 24TC-Lの`Gi0/2`ポートは、Cisco Aironet 2700と接続します。  

また、各機器の設置場所は以下の通りです。  
![network2](https://media.discordapp.net/attachments/1113308387329978420/1164132123989512222/c13a92671451b777.png?ex=65421986&is=652fa486&hm=c69e4817efafa658160e0ed69d700e643f247692f2fdf0399af3580237012448&=&width=520&height=608)

注意: ループを防ぐため、必ず図の通りに配線を行ってください。ループが発生した場合、ネットワーク障害が発生します。

### 光ファイバーの配線について
光ファイバーの芯線は石英ガラスや樹脂でできており、非常に脆いため、取り扱いに十分注意してください。折ったり、捻ったり、強く引っ張ったりすると、芯線が折れてしまい、光ファイバーが使用できなくなります。  
また、光ファイバーの先端を傷つけたり汚したりしないよう、敷設時は光ファイバーの先端保護用のキャップを取り付けてください。

光ファイバーには、OM1(オレンジ色)もしくはOM3(アクア色)のマルチモードファイバーを使用します。光ファイバー先端の端子はLCコネクタです。  
光トランシーバーは、スイッチのSFPポートとLCコネクタを使用して接続します。  
![optical_fiber](https://media.discordapp.net/attachments/1066393230700183642/1073889441275461642/PXL_20230211_075824171.jpg?ex=653ccbfa&is=652a56fa&hm=5b49c259e680e6fa372581930d8a7bdf88d225ae6d0d4e4bd130d000fcd3fa90&=&width=999&height=749)
スイッチ(SFPポート)---光トランシーバ---(LCコネクタ)---光ファイバー と接続します。
#### 光ファイバーのスイッチへの接続
1. スイッチのSFPポートのカバーを取り外します。
2. 光トランシーバーをスイッチのSFPポートに奥まで差し込みます。向きがありますので、十分注意して差し込みます。  
差し込むと、光トランシーバーからレーザーが出力されますので、直視しないように注意します。
3. 光トランシーバーに光ファイバーを差し込みます。向きがありますので、十分注意して差し込みます。  
このとき、光ファイバーの先端の保護キャップは取り外します。
4. カチッと音が鳴り固定されていれば、接続完了です。  
#### 光ファイバーのスイッチからの取り外し
1. 光ファイバーを光トランシーバーから取り外します。ツメを押しながら、光ファイバーを引き抜きます。  
引き抜いた後、光トランシーバーからレーザーが出力されますので、直視しないように注意します。
2. 光ファイバーの先端保護用のキャップを取り付けます。
3. 光トランシーバーをスイッチから取り外します。光トランシーバーのレバーを下ろし、そのレバーを引き、光トランシーバーをスイッチから引き抜きます。
4. スイッチのSFPポートにカバーを取り付けます。

### VLANの設定
スイッチ間の接続ができたら、スイッチと各種機器の接続を行います。  
先述の図にポート番号が記載されていないものについては、スイッチの先述のTaggedポート以外の任意のポートに各種機器を接続し、適切なVLANを設定します。  
以下の手順で、各種機器と接続したポートにVLANを設定します。
#### VLANとは
VLANとは、Virtual LANの略で、スイッチを論理的に分割する技術です。  
VLANに対応しているスイッチでは、一つのスイッチを分割してまるで複数のスイッチがあるかのように扱うことができます。  
音楽技術部では以下のようにVLANを作成しています。
- VLAN10: PRO DJ LINK用
- VLAN15: プロジェクタ制御用
- VLAN20: NDI用
- VLAN30: 照明用
- VLAN99: 管理用

例えば、あるスイッチのポート1をVLAN10に設定した場合、そのスイッチのポート1に接続された機器は、VLAN10に設定された他のスイッチのポートに接続された機器と通信することができますが、VLAN10以外の他のVLANに設定されたスイッチのポート1に接続された機器とは直接通信することができません。

以下に、各VLANの概要を示します。
- VLAN10: PRO DJ LINK用  
DJ機器とコンピュータを接続するためのVLANです。  
アドレス範囲: 192.168.10.0/24  
DHCPによる自動割当範囲: 192.168.10.101 - 192.168.10.200  
ゲートウェイ: 192.168.10.1  
DNSサーバ: 192.168.10.1

- VLAN15: プロジェクタ制御用
プロジェクタを制御するためのVLANです。  
アドレス範囲: 172.16.0.0/22  
DHCP無効  
ゲートウェイ: 172.16.0.1  
DNSサーバ: 172.16.0.1  

- VLAN20: NDI用  
NDIによる映像送受信を行うためのVLANです。  
アドレス範囲: 192.168.20.0/24  
DHCPによる自動割当範囲: 192.168.20.101 - 192.168.20.200  
ゲートウェイ: 192.168.20.1  
DNSサーバ: 192.168.20.1  

- VLAN30: 照明用  
照明機器を制御するためのVLANです。  
アドレス範囲: 192.168.11.0/24  
DHCP無効  
ゲートウェイ: 192.168.11.1  
DNSサーバ: 192.168.11.1  

- VLAN99: 管理用  
スイッチやルーターに接続したり、サーバーに接続したりするためのVLANです。  
アドレス範囲: 192.168.99.0/24  
DHCPによる自動割当範囲:  192.168.99.101 - 192.168.99.200  
ゲートウェイ: 192.168.99.1  
DNSサーバ: 192.168.99.1  

#### VLANの設定方法
VLANの設定方法は、スイッチの機種によって異なります。
##### Cisco Catalyst 2960 Plus 24TC-L  
このスイッチは、DJ用のスイッチとして設定してあるため、基本的に設定の変更は必要ありません。  
既に、Fa0/1 - Fa0/22のポートがVLAN10に設定されています。  
1. コンソールケーブルを使用して、シリアル通信でスイッチに接続するか、`192.168.99.2`へSSH接続を行います。  
2. スイッチにログインします。
3. `enable`コマンドを実行して、特権モードに移行します。
4. `show vlan`コマンドを実行して、現在のVLANの状態を確認します。
5. `configure terminal`コマンドを実行して、グローバルコンフィグモードに移行します。  
6. `interface FastEthernet0/X`コマンドを実行(Xは変更したいポート番号)して、ポートを選択します。複数のポートを同時に変更したい場合は、`interface range FastEthernet0/X - Y`コマンドを実行して、まとめてポートを選択します。  
7. `switchport mode access`コマンドを実行して、アクセスポートに設定します。
8. `no switchport access vlan`コマンドを実行して、ポートのVLAN設定を削除します。
9. `switchport access vlan [VLAN ID]`コマンドを実行して、VLANを割り当てます。
10. `spanning-tree edgeport`コマンドを実行して、ポートをedgeポートに設定します。この設定を行わないと、端末のリンクアップに時間を要し、特にXDJ-XZ等のDJ機材はDHCPによるIPアドレスの取得に失敗します。
11. 変更は即時反映されます。`end`コマンドで特権モードに戻り、`show vlan`コマンドを実行して、VLANの状態が変更されていることを確認します。
12. `write memory`コマンドで設定を保存します。保存を行うと、再起動を行っても設定が保持されます。  

##### Allied Telesis AT-x600-48Ts  
このスイッチは、サーバ用のスイッチとして設定してあるため、基本的に設定の変更は必要ありません。  
1. コンソールケーブルを使用して、シリアル通信でスイッチに接続するか、`192.168.99.3`へSSH接続を行います。  
2. スイッチにログインします。  
3. `enable`コマンドを実行して、特権モードに移行します。  
4. `show vlan all`コマンドを実行して、現在のVLANの状態を確認します。  
5. `configure terminal`コマンドを実行して、グローバルコンフィグモードに移行します。  
6. `interface port1.0.X` コマンドを実行(Xは変更したいポート番号)して、ポートを選択します。複数のポートを同時に変更したい場合は、`interface range port1.0.X - Y`コマンドを実行して、まとめてポートを選択します。  
7. `switchport mode access`コマンドを実行して、アクセスポートに設定します。  
8. `no switchport access vlan`コマンドを実行して、ポートのVLAN設定を削除します。  
9. `switchport access vlan [VLAN ID]`コマンドを実行して、VLANを割り当てます。  
10. 変更は即時反映されます。`end`コマンドで特権モードに戻り、`show vlan all`コマンドを実行して、VLANの状態が変更されていることを確認します。  
11. `write memory`コマンドで設定を保存します。保存を行うと、再起動を行っても設定が保持されます。  

##### Allied Telesis AT-x210-24GT  
このスイッチは、返しプロジェクター周辺用としての役割を持っているため、基本的に設定の変更が必要です。  
なお、このスイッチは先述のAllied Telesis AT-x600-48Tsと同じ文法で設定変更が可能です。
1. コンソールケーブルを使用して、シリアル通信でスイッチに接続するか、`192.168.99.4`へSSH接続を行います。  
2. スイッチにログインします。  
3. `enable`コマンドを実行して、特権モードに移行します。  
4. `show vlan all`コマンドを実行して、現在のVLANの状態を確認します。  
5. `configure terminal`コマンドを実行して、グローバルコンフィグモードに移行します。  
6. `interface port1.0.X` コマンドを実行(Xは変更したいポート番号)して、ポートを選択します。複数のポートを同時に変更したい場合は、`interface range port1.0.X - Y`コマンドを実行して、まとめてポートを選択します。  
7. `switchport mode access`コマンドを実行して、アクセスポートに設定します。  
8. `no switchport access vlan`コマンドを実行して、ポートのVLAN設定を削除します。  
9. `switchport access vlan [VLAN ID]`コマンドを実行して、VLANを割り当てます。  
10. 変更は即時反映されます。`end`コマンドで特権モードに戻り、`show vlan all`コマンドを実行して、VLANの状態が変更されていることを確認します。  
11. `write memory`コマンドで設定を保存します。保存を行うと、再起動を行っても設定が保持されます。  

##### Allied Telesis GS924M V2
このスイッチは、照明用もしくはVJ用のスイッチとしての役割を持っており、基本的に設定の変更が必要です。  
1. スイッチの21もしくは22番ポートに接続し、任意のWebブラウザで`192.168.99.5`もしくは`192.168.99.6`へ接続を行います。(対象となるスイッチに合わせて、接続先を変更してください。接続先は、LED Boothのスイッチは`192.168.99.5`へ、VJ Boothのスイッチは`192.168.99.6`です。)  
2. スイッチにログインします。  
3. バーチャルLANの設定を開き、対象となるVLAN IDを選択し、VLANを変更したいポートを`タグなし`に変更します。
4. 変更は即時反映されます。問題がなさそうでしたら、`設定保存`を選択し、設定を保存します。  

#### VLAN間ルーティングの設定
先述の通り、VLAN間では直接通信することができないと説明しましたが、ルータを使用することでVLAN間で通信を行うことができます。  
音楽技術部では、ルータとしてNEC UNIVERGE IX3110を使用しており、LED制御用のPCはVJ用ネットワークであるVLAN20に接続、LED基盤はVLAN30に接続し、ルータによってVLAN間通信を行っています。  
ここで、VLAN10とVLAN20には、Web認証によるアクセス制限を行っており、Web認証を行わないと、VLAN間の通信を行えないようになっています。  
したがって、LED制御用のPCは、Web認証を行わないとLED基盤との通信ができません。
以下に、Web認証の方法を示します。  
1. VLAN20に接続します。
2. 自動でWeb認証画面が開きます。開かない場合は、`http://technotut.net`にアクセスします。  
3. Web認証画面が開くので、ユーザー名とパスワードを入力し、ログインします。
4. Web認証が完了し、LED制御基板と通信できるようになります。  

なお、Web認証は120分間通信がない場合、自動で再び通信を遮断します。  
恒久的に通信を許可したい場合は、以下の手順でルータにMACアドレスを登録しWeb認証をバイパスさせます。  
1. コンソールケーブルを使用して、シリアル通信でルータに接続するか、`192.168.99.1`へSSH接続を行います。  
2. ルータにログインします。  
3. `enable`コマンドを実行して、グローバルコンフィグモードに移行します。
4. PCのIPアドレスを確認します。Windowsの場合は、`ipconfig`コマンド、Linuxの場合は、`ip addr`コマンドをターミナルで実行します。  
5. `show arp`コマンドを実行して、ルータに登録されているARPテーブルを確認します。  
IPアドレスとMACアドレスの対応が表示されるので、PCのIPアドレスに対応するMACアドレスを探しコピーします。Tera Termを使用している場合は、コピーしたい箇所を選択し、`Alt + C`を押すとコピーできます。  
6. `web-auth ignore-address [MACアドレス]`コマンドを実行して、MACアドレスを登録します。
7. Web認証がバイパスされ、設定の必要なくLED制御基板と通信できるようになります。  
8. 通信が可能になりましたら、`write memory`コマンドで設定を保存します。保存を行うと、再起動を行っても設定が保持されます。  

Web認証については、認証なしでは同じネットワーク内の通信が許可されていますので、PRO DJ LINKやNDIの通信はWeb認証なしで可能です。  

#### 各機器のVLAN IDについて  
各機器と接続する際のVLAN IDは以下の通りに設定します。
VLAN10: XDJ-XZ, PRO DJ LINKを行うコンピュータ  
VLAN20: VJ用コンピュータ, VJミキサー, LED制御用コンピュータ  
VLAN30: LED基盤, LED Display, LED Displayに接続されたNETGEAR製L2スイッチ  

##### Taggedポートを用いた接続
LinuxやWindows Serverでは、Taggedポートに接続し、`nmtui`コマンド等でVLAN IDを指定することで、特定のVLANでの通信を行うことができますが、民生用WindowsではOSの制限により、Taggedポートに接続することは基本的にできません。しかしながら、Windows環境においても一部のNIC(ネットワークインターフェースカード)では、Taggedポートに接続しVLAN IDを指定することで、特定のVLANでの通信を行うことができます。
NICのメーカーによって、VLAN IDの指定方法が異なります。以下では、RealtekとIntelのNICを使用している場合の設定方法を示します。  
###### Realtek社のNICを使用している場合
1. Realtek社の公式サポートページから、Realtek Ethernet Diagnostic Utilityをダウンロードしインストールします。  
2. Realtek Ethernet Diagnostic Utilityを起動します。  
3. 一番左で目的のNICを選択(Realtek USB GbE Family Controller など)し、`VLAN`タブを選択します。  
4. `追加`を選択し、VLAN IDを入力します。追加したいVLANが複数ある場合は、必要なVLAN IDをすべて追加します。  
5. 変更は即時反映されます。うまくいかない場合は、コンピュータを再起動してみてください。それでもうまくいかない場合は、管理者にご相談ください。  
6. もとに戻す場合は、`削除`を選択し、VLAN IDをすべて削除します。  

###### Intel社のNICを使用している場合 (Windows 10のみ)
1. Intel社の公式サポートページから、Intel PROSetをダウンロードしインストールします。(Windows 11には非対応)  
2. 管理者権限でIntel PROSetを起動します。  
3. 左メニューで目的のNICを選択(Intel(R) Ethernet Connection I219-V など)し、`チーム化/VLAN`タブを選択します。  
4. `新規作成`を選択し、VLAN IDを入力します。追加したいVLANが複数ある場合は、必要なVLAN IDをすべて追加します。  
5. 変更は即時反映されます。うまくいかない場合は、コンピュータを再起動してみてください。それでもうまくいかない場合は、管理者にご相談ください。  
6. もとに戻す場合は、`削除`を選択し、VLAN IDをすべて削除します。  


### プロジェクタのセットアップ  
スクリーンは垂直に、一切の歪み・シワのないように設置します。  
プロジェクタは水平な場所に、スクリーンに対して並行になるように設置します。  
画質が低下するため、プロジェクタの台形補正機能は使用しません。  
故障の原因となるため、プロジェクタのレンズには絶対に触れないこと。  
ランプ寿命短縮の原因となるため、プロジェクタの電源の入れ切りを頻繁にしない。30分は置くこと。  

#### ケーブルの接続
プロジェクタの電源ケーブルを接続します。  
HDMIスプリッタとHDMIケーブル2本とDisplayPort to HDMIケーブルを使用して、返しプロジェクタとDJ裏プロジェクタを`Panasonic Medicom MV-H28P`に接続します。  
プロジェクタのLANケーブルは、先述の手順で任意のスイッチのVLAN15に接続します。  

#### プロジェクタの設定
プロジェクタ起動後、メニューから設定を行います。  
設置場所によって、反転の設定を行います。拡張設定タブから設置モードを変更します。  
省エネモードが有効になっている場合は、無効にします。  
画質設定に関しては変更しないこと。明るさを上げたりすると白飛びします。  

以上の設定が済んだら、適当な映像を映して、スクリーンに映るか確認します。  

その後、位置の微調整・フォーカスの設定を行います。  
フォーカスはプロジェクター天面もしくは側面のレバーを操作することで調整できます。メニューを表示して、中央の文字が鮮明になるように調整します。  
### サーバーのセットアップ
配線図の通りにLANケーブルが接続されていることを確認して、電源を付けます。

### VJ用コンピュータのセットアップ
VJ用コンピュータは、先述の手順でVLAN20に接続します。  
なお、各コンピュータの使用場所は以下の通りです。
- 闇鍋PC(自作), Windows 10 Pro: VJ Booth(VJ PC)
- 富士通 ESPRIMO D582/G, Windows 10 Pro: VJ Booth(VJミキサー)
- Panasonic Medicom MV-H28P, Xubuntu 22.04: プロジェクタ表示用, 返しプロジェクタ裏

#### 闇鍋PC(自作)
1. コンピュータを起動します。  
2. Resolume Avenue を起動します。  
3. 出力先を`NDI`に設定します。

#### 富士通 ESPRIMO D582/G
このコンピュータは、LANポートが2つありますが、拡張ボードのLANポートはVLAN10に、マザーボードのLANポートはVLAN20に接続します。
1. コンピュータを起動します。  
2. OBS Studioを起動します。  
3. Studio Modeに変更します。  
4. `NDI Output`を有効にし、出力名を`VJMaster`に設定します。  
5. `NDI Source`を有効にし、闇鍋PCのNDI出力を受信します。  
このとき、ハードウェアアクセラレーションおよび、遅延`低`の設定を有効にします。  
6. 闇鍋PC以外にNDI経由でプロジェクタに出力を行うPCがある場合は、シーンを新たに作成し、同様の手順で設定を行います。
7. HDMI入力が必要な場合は、キャプチャーボード`IODATA GV-USB3`を接続し、OBS Studioでキャプチャーを行います。新たにシーンを作成し、ソースに映像キャプチャデバイスを追加します。  
8. シーンの名前を分かりやすいものに変更します。  
9. Windows ロゴキー を押し、`remote`と入力し、`リモートデスクトップ接続`を選択し、リモートデスクトップ接続を開きます。  
10. `192.168.10.99`に接続します。  
11. ウィンドウサイズを調整し、VJが曲情報を見やすい位置にします。

#### Panasonic Medicom MV-H28P  
※このコンピュータは他のコンピュータとは異なり、VLAN20に接続せず、Taggedポートに接続します。
1. プロジェクター(DisplayPort)と作業用モニター(VGA)を接続します。  
2. プロジェクターの電源を入れます。
3. コンピュータを起動します。
4. 設定を開き、モニターの設定を行います。  
作業用モニターをメインディスプレイに設定し、プロジェクターを拡張ディスプレイに設定します。  
プロジェクターの解像度は、`1280x720`に設定します。
5. `Ctrl + Alt + T`を押して、ターミナルを開きます。  
`obs` コマンドを実行して、OBS Studioを起動します。  
6. NDI Sourceを有効にし、`富士通 ESPRIMO D582/G`からの`VJMaster`NDI出力を受信します。
7. プレビューウィンドウを右クリックし、`Fullscreen Projector`を選択します。  
`EPSON PJ`を選択すると、プロジェクターに映像が出力されます。  
8. 作業用モニターで、更に別のターミナルウィンドウを開き、`cd prolink-tools`コマンドを実行します。
9. `./prolink-tools`コマンドを実行し、PRO DJ LINKの情報を表示します。
10. OBSに戻り、曲情報が表示されていることを確認します。表示されない場合は、ウェブブラウザでprolink-toolsからの曲情報を追加します。  
11. また別のターミナルウィンドウを開き、`obs`コマンドを実行して、別のセッションのOBS Studioを起動します。
12. `NDI Source`を有効にし、各NDIカメラの出力を受信します。このとき、帯域幅は`低`に設定します。  
13. プレビューウィンドウを右クリックし、`Window Projector`を選択します。  
14. LEDオペレータに見やすい位置にモニターを調整し、ウィンドウサイズを調整します。  

### カメラのセットアップ  
カメラは、以下の機材を使用します。  
- Apple iPhone SE(第3世代)
- Huawei P20 Pro
- OPPO Reno A
- Lenovo ThinkPad T430

#### iPhone
1. 電源ボタンを長押しして、iPhoneを起動します。
2. `設定`アプリを開き、`Wi-Fi`を選択し、`TechnoTUT_Cam`に接続します。　　
3. `LM-Cam`アプリを起動します。
4. フォーカスを合わせ、適当な位置に設置します。
5. 赤い丸のボタンを押して、NDI送信を開始します。
6. ロックボタンを押して、画面をロックします。

#### Android
Huawei P20 Pro, OPPO Reno Aは、以下の手順で設定します。
1. 電源ボタンを長押しして、Androidを起動します。
2. 起動したら、`設定`アプリを開き、`Wi-Fi`を選択し、`TechnoTUT_Cam`に接続します。  
3. `NDI HX Camera`アプリを起動します。  
4. フォーカスを合わせ、適当な位置に設置します。  
5. 青い`NDI`ボタンを押して、NDI送信を開始します。  

#### Lenovo ThinkPad T430  
1. 電源ボタンを押して、ThinkPadを起動します。Xubuntuが起動します。  
2. LANケーブルを接続し、VLAN20に接続します。  
3. `Ctrl + Alt + T`を押して、ターミナルを開きます。  
4. `obs`コマンドを実行して、OBS Studioを起動します。
5. キャプチャーボードをUSB3.0ポートに接続します。
6. キャプチャーボードの先にHDMI to MicroHDMIケーブルを接続し、カメラを接続します。  
7. `映像キャプチャデバイス`を追加し、カメラの映像を受信します。
8. `NDI Output`を有効にし、出力名を`Cam2`に設定します。
9. プレビューウィンドウを右クリックし、`Fullscreen Projector`を選択します。